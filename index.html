<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Draw Dash Bust</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/phaser.min.js"></script>
    <style>
        /* --- åŸæœ‰æ ·å¼ä¿æŒä¸å˜ --- */
        .rules-container {
            text-align: left; padding: 0 10px; font-size: 16px; line-height: 1.6; color: #333;
            max-height: 60vh; overflow-y: auto;
        }
        .rules-container h3 {
            color: #d84315; border-bottom: 2px solid #ffab91; padding-bottom: 5px;
            margin-top: 20px; margin-bottom: 10px;
        }
        .rules-container ul { padding-left: 20px; margin: 0; }
        .rules-container li { margin-bottom: 8px; }
        .item-tag {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 14px; font-weight: bold; color: #fff; margin-right: 5px;
        }
        .tag-def { background-color: #4caf50; }
        .tag-atk { background-color: #f44336; }
        .tag-bonus { background-color: #ff9800; }

        .html-ui-btn {
            position: absolute; bottom: 30px; right: 30px; z-index: 5000;
            background-color: #78909c; color: white; border: none;
            border-radius: 50%; width: 60px; height: 60px;
            font-size: 24px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s, background-color 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        #html-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 6000; display: flex; justify-content: center; align-items: center;
        }
        .html-menu-box {
            background-color: #fff8e1; border: 4px solid #8d6e63; border-radius: 20px;
            padding: 30px; width: 280px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .html-menu-title {
            text-align: center; color: #5d4037; margin: 0 0 15px 0;
            font-size: 28px; border-bottom: 2px dashed #d7ccc8; padding-bottom: 10px;
        }
        .html-menu-item {
            padding: 12px; border: none; border-radius: 10px;
            font-size: 18px; font-weight: bold; color: white;
            cursor: pointer; transition: filter 0.2s; font-family: inherit;
        }
        .html-menu-item.resume { background-color: #66bb6a; box-shadow: 0 4px 0 #388e3c; }
        .html-menu-item.normal { background-color: #42a5f5; box-shadow: 0 4px 0 #1976d2; }
        .html-menu-item.warning { background-color: #ef5350; box-shadow: 0 4px 0 #d32f2f; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .hidden { display: none !important; }

        /* --- ğŸŸ¢ è°ƒè¯•å·¥å…· (Debug Ball) æ ·å¼ --- */
        #debug-ball {
            position: fixed; top: 50px; left: 20px; width: 50px; height: 50px;
            background: radial-gradient(circle at 30% 30%, #ff5252, #b71c1c);
            color: white; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 10px; font-weight: bold;
            cursor: move; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            user-select: none; touch-action: none; border: 2px solid #fff;
        }
        #debug-menu {
            position: fixed; top: 110px; left: 20px; width: 220px;
            background: rgba(45, 45, 45, 0.95); border-radius: 12px;
            padding: 15px; color: #fff; z-index: 9998; border: 1px solid #555;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); font-family: sans-serif;
        }
        .debug-title { font-size: 16px; margin-bottom: 12px; border-bottom: 1px solid #555; padding-bottom: 5px; color: #ffeb3b; }
        .debug-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .debug-label { font-size: 13px; }
        .debug-ctrl { display: flex; align-items: center; gap: 5px; }
        .debug-btn { width: 25px; height: 25px; background: #555; border: none; color: white; border-radius: 4px; cursor: pointer; }
        .debug-input { width: 40px; text-align: center; background: #111; color: #0f0; border: 1px solid #444; border-radius: 4px; font-weight: bold; }
        .debug-apply { width: 100%; padding: 8px; background: #2e7d32; border: none; color: white; border-radius: 6px; font-weight: bold; margin-top: 5px; cursor: pointer; }
        .debug-apply:active { background: #1b5e20; }
    </style>
</head>
<body>

<div id="game-container"></div>

<div id="debug-root"></div>

<button id="html-menu-btn" class="html-ui-btn hidden">â˜°</button>

<div id="html-menu-overlay" class="hidden">
    <div class="html-menu-box">
        <h2 class="html-menu-title">æ¸¸æˆæš‚åœ</h2>
        <button id="btn-resume" class="html-menu-item resume">å›åˆ°æ¸¸æˆ</button>
        <button id="btn-restart" class="html-menu-item normal">é‡æ–°å¼€å§‹</button>
        <button id="btn-surrender" class="html-menu-item warning">æ”¾å¼ƒæœ¬å±€</button>
        <button id="btn-home" class="html-menu-item normal">å›åˆ°é¦–é¡µ</button>
    </div>
</div>

<div id="start-screen">
    <div class="title-container">
        <div class="title-group"><div class="cn-text">æŠ½!</div><div class="en-text">DRAW</div></div>
        <div class="title-group"><div class="cn-text">è·‘!</div><div class="en-text">DASH</div></div>
        <div class="title-group"><div class="cn-text">çˆ†!</div><div class="en-text">BUST</div></div>
    </div>
    <div class="menu-buttons">
        <button id="btn-start" class="menu-btn start-btn">å¼€å§‹æ¸¸æˆ</button>
        <button id="btn-rules" class="menu-btn rules-btn">è§„åˆ™ä»‹ç»</button>
    </div>
    <div class="footer-text">v1.0.0 by PikaZHJ</div>
</div>

<div id="setup-screen" class="hidden">
    <h2 class="setup-title">é€‰æ‹©ç”µè„‘ç©å®¶æ•°é‡</h2>
    <div class="counter-container">
        <button id="btn-minus" class="counter-btn">-</button>
        <span id="ai-count-display">3</span>
        <button id="btn-plus" class="counter-btn">+</button>
    </div>
    <button id="btn-launch" class="menu-btn start-btn">è¿›å…¥æ¸¸æˆ</button>
    <button id="btn-back" class="text-btn">è¿”å›</button>
</div>

<div id="rules-modal" class="hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>æ¸¸æˆè§„åˆ™è¯´æ˜</h2>
            <button id="btn-close-rules" class="close-btn">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="rules-container">
                <section><h3>ğŸ† èƒœåˆ©æ¡ä»¶</h3><p>ç‡å…ˆç´¯ç§¯æ€»åˆ†è¾¾åˆ° 200åˆ† çš„ç©å®¶è·èƒœã€‚</p></section>
                <section><h3>ğŸ² åŸºç¡€ç©æ³•</h3><ul><li>æŠ½åˆ°æ‰‹ç‰Œä¸­å·²æœ‰çš„æ•°å­—å³çˆ†ç‰Œï¼Œæœ¬è½®0åˆ†ã€‚</li><li>è§å¥½å°±æ”¶ï¼Œå°†æœ¬è½®å¾—åˆ†å­˜å…¥æ€»åˆ†ã€‚</li></ul></section>
                <section><h3>ğŸƒ é“å…·å›¾é‰´</h3><ul><li>å¤: æŠµæ¶ˆä¸€æ¬¡çˆ†ç‰Œã€‚</li><li>å†»: è·³è¿‡å¯¹æ‰‹ä¸€å›åˆã€‚</li><li>åŒ: æ¯æ¬¡æŠ½ä¸¤å¼ ç‰Œã€‚</li></ul></section>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { launchGame, getGlobalStats } from './js/main.js';

    // ğŸŸ¢ è°ƒè¯•æ¨¡å¼å¼€å…³
    const isDebug = true;

    // ğŸŸ¢ [æ–°å¢] 1. åˆ›å»º HTML å±‚é¢çš„ä¸»é¡µ BGM å¯¹è±¡
    // ç¡®ä¿è·¯å¾„æ­£ç¡®ï¼ŒéŸ³é‡è®¾ä¸º 0.3 (ä¸æ¸¸æˆå†…ä¿æŒä¸€è‡´)
    const homeBgm = new Audio('assets/audio/bgm_home.mp3');
    homeBgm.loop = true;
    homeBgm.volume = 0.3;

    // ğŸŸ¢ [æ–°å¢] 2. åœæ­¢ä¸»é¡µéŸ³ä¹çš„è¾…åŠ©å‡½æ•° (å¸¦ä¸€ç‚¹æ·¡å‡ºæ•ˆæœ)
    function stopHomeBgm() {
        if (!homeBgm.paused) {
            // ç®€å•æ·¡å‡ºé€»è¾‘
            let vol = homeBgm.volume;
            const fade = setInterval(() => {
                if (vol > 0.05) {
                    vol -= 0.05;
                    homeBgm.volume = vol;
                } else {
                    clearInterval(fade);
                    homeBgm.pause();
                    homeBgm.currentTime = 0; // é‡ç½®è¿›åº¦
                }
            }, 50);
        }
    }

    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${(h<10?'0'+h:h)}:${(m<10?'0'+m:m)}:${(s<10?'0'+s:s)}`;
    }

    window.addEventListener('DOMContentLoaded', () => {

        // ğŸŸ¢ [æ–°å¢] 3. å…¨å±€ç‚¹å‡»ç›‘å¬ï¼šåªè¦ç”¨æˆ·ç‚¹äº†å±å¹•ï¼Œå°±å¼€å§‹æ’­æ”¾ä¸»é¡µéŸ³ä¹
        const tryPlayBgm = () => {
            // åªæœ‰å½“éŸ³ä¹æš‚åœæ—¶æ‰å°è¯•æ’­æ”¾ï¼Œé¿å…é‡å¤è§¦å‘
            if (homeBgm.paused) {
                homeBgm.play().catch(e => console.log("ç­‰å¾…äº¤äº’ä»¥æ’­æ”¾éŸ³é¢‘"));
            }
            // ç§»é™¤ç›‘å¬ï¼Œå› ä¸ºåªéœ€è¦è§¦å‘ä¸€æ¬¡
            document.removeEventListener('click', tryPlayBgm);
            document.removeEventListener('touchstart', tryPlayBgm);
        };
        document.addEventListener('click', tryPlayBgm);
        document.addEventListener('touchstart', tryPlayBgm);


        // --- ğŸŸ¢ è°ƒè¯•å°çƒé€»è¾‘æ³¨å…¥ ---
        if (isDebug) {
            const root = document.getElementById('debug-root');
            root.innerHTML = `
                <div id="debug-ball">DEBUG</div>
                <div id="debug-menu" class="hidden">
                    <div class="debug-title">å¼€å‘è€…è°ƒè¯•èœå•</div>
                    <div class="debug-row">
                        <span class="debug-label">å¼ºåˆ¶è½ç‚¹ (1-24):</span>
                        <div class="debug-ctrl">
                            <button class="debug-btn" id="db-minus">-</button>
                            <input type="text" class="debug-input" id="db-target" value="10" readonly>
                            <button class="debug-btn" id="db-plus">+</button>
                        </div>
                    </div>
                    <button class="debug-apply" id="db-apply" style="margin-bottom:10px;">è®¾ç½®ä¸‹æ¬¡è½ç‚¹</button>
                    <div class="debug-row">
                        <span class="debug-label">ä¿®æ”¹æˆ‘æ–¹ç§¯åˆ†:</span>
                        <div class="debug-ctrl">
                            <button class="debug-btn" id="score-minus">-10</button>
                            <button class="debug-btn" id="score-plus">+50</button>
                        </div>
                    </div>
                    <div class="debug-row" style="flex-direction:column; gap:8px;">
                        <button class="debug-apply" id="db-freeze-ai" style="background:#607d8b;">ğŸ¥¶ å†»ç»“æ‰€æœ‰ç”µè„‘</button>
                        <button class="debug-apply" id="db-give-shield" style="background:#f57c00;">ğŸ›¡ï¸ è·å¾—ä¿æŠ¤çŠ¶æ€</button>
                    </div>
                    <div style="font-size:10px; color:#aaa; margin-top:8px;">* å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯å›åˆ</div>
                </div>
            `;

            const ball = document.getElementById('debug-ball');
            const menu = document.getElementById('debug-menu');
            const dbTarget = document.getElementById('db-target');
            let isDragging = false;

            ball.onpointerdown = (e) => {
                isDragging = false;
                let shiftX = e.clientX - ball.getBoundingClientRect().left;
                let shiftY = e.clientY - ball.getBoundingClientRect().top;

                function moveAt(pageX, pageY) {
                    isDragging = true;
                    ball.style.left = pageX - shiftX + 'px';
                    ball.style.top = pageY - shiftY + 'px';
                    menu.style.left = pageX - shiftX + 'px';
                    menu.style.top = (pageY - shiftY + 60) + 'px';
                }

                function onPointerMove(e) { moveAt(e.clientX, e.clientY); }
                document.addEventListener('pointermove', onPointerMove);

                ball.onpointerup = () => {
                    document.removeEventListener('pointermove', onPointerMove);
                    ball.onpointerup = null;
                };
            };
            ball.onclick = () => { if (!isDragging) menu.classList.toggle('hidden'); };
            document.getElementById('db-minus').onclick = () => { let v = parseInt(dbTarget.value); if (v > 1) dbTarget.value = v - 1; };
            document.getElementById('db-plus').onclick = () => { let v = parseInt(dbTarget.value); if (v < 24) dbTarget.value = v + 1; };
            document.getElementById('db-apply').onclick = () => { window.__DEBUG_NEXT_MOVE__ = parseInt(dbTarget.value); alert(`å·²è®¾ç½®ä¸‹æ¬¡ç§»åŠ¨ç»ˆç‚¹ä¸º: ${window.__DEBUG_NEXT_MOVE__}æ ¼`); menu.classList.add('hidden'); };
            document.getElementById('score-minus').onclick = () => { window.__DEBUG_CMD__ = { type: 'ADD_SCORE', value: -10 }; };
            document.getElementById('score-plus').onclick = () => { window.__DEBUG_CMD__ = { type: 'ADD_SCORE', value: 50 }; };
            document.getElementById('db-freeze-ai').onclick = () => { window.__DEBUG_CMD__ = { type: 'FREEZE_AI' }; };
            document.getElementById('db-give-shield').onclick = () => { window.__DEBUG_CMD__ = { type: 'GIVE_SHIELD' }; };
        }

        // --- åŸæœ‰é€»è¾‘ä»£ç  ---
        const startScreen = document.getElementById('start-screen');
        const setupScreen = document.getElementById('setup-screen');
        const rulesModal = document.getElementById('rules-modal');
        const btnStart = document.getElementById('btn-start');
        const btnRules = document.getElementById('btn-rules');
        const btnCloseRules = document.getElementById('btn-close-rules');
        const menuButtonsDiv = document.querySelector('.menu-buttons');
        const btnMinus = document.getElementById('btn-minus');
        const btnPlus = document.getElementById('btn-plus');
        const countDisplay = document.getElementById('ai-count-display');
        const btnLaunch = document.getElementById('btn-launch');
        const btnBack = document.getElementById('btn-back');

        const confirmModal = document.createElement('div');
        confirmModal.id = 'confirm-modal';
        confirmModal.style.cssText = `display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; justify-content: center; align-items: center;`;
        confirmModal.innerHTML = `<div style="background-color: #fff8e1; width: 85%; max-width: 450px; padding: 30px; border-radius: 20px; border: 4px solid #8d6e63; text-align: center;"><h2 style="color: #5d4037;">æç¤º</h2><p>ç¡®å®šè¦å¼€å§‹æ–°æ¸¸æˆå—ï¼Ÿ</p><div style="display: flex; justify-content: space-around;"><button id="btn-confirm-no" style="background:#90a4ae; color:white; padding:10px 20px; border-radius:10px; border:none;">å–æ¶ˆ</button><button id="btn-confirm-yes" style="background:#ff7043; color:white; padding:10px 20px; border-radius:10px; border:none;">ç¡®å®š</button></div></div>`;
        document.body.appendChild(confirmModal);
        document.getElementById('btn-confirm-no').onclick = () => confirmModal.style.display = 'none';

        const recordModal = document.createElement('div');
        recordModal.id = 'record-modal';
        recordModal.style.cssText = `display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;`;
        recordModal.innerHTML = `
            <div style="background-color: #fff8e1; width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; border: 4px solid #8d6e63; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);">
                <h2 style="color: #5d4037; margin-bottom: 20px; font-size: 28px;">ğŸ† æ¸¸æˆè®°å½•</h2>
                <div style="margin: 20px 0; font-size: 18px; color: #333; display: flex; flex-direction: column; gap: 12px; padding: 0 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #d7ccc8; padding-bottom: 8px;"><span>ğŸ® å®Œæˆæ¸¸æˆï¼š</span><span id="stat-completed" style="font-weight:bold; color:#e65100;">0 å±€</span></div>
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #d7ccc8; padding-bottom: 8px;"><span>ğŸ¥‡ è·å¾—ç¬¬ä¸€ï¼š</span><span id="stat-wins" style="font-weight:bold; color:#4caf50;">0 æ¬¡</span></div>
                    <div style="display: flex; justify-content: space-between; align-items: center;"><span>â±ï¸ ç´¯è®¡æ—¶é—´ï¼š</span><span id="stat-time" style="font-weight:bold; color:#1976d2;">00:00:00</span></div>
                </div>
                <button id="btn-close-record" style="background-color: #8d6e63; color: white; border: none; padding: 10px 30px; font-size: 18px; border-radius: 12px; cursor: pointer; margin-top: 15px; font-weight:bold; width: 100%;">å…³é—­</button>
            </div>
        `;
        document.body.appendChild(recordModal);
        document.getElementById('btn-close-record').onclick = () => recordModal.style.display = 'none';

        const btnRecord = document.createElement('button');
        btnRecord.innerText = "æ¸¸æˆè®°å½•"; btnRecord.className = "menu-btn"; btnRecord.style.backgroundColor = "#795548"; btnRecord.style.marginTop = "15px";
        if (menuButtonsDiv) menuButtonsDiv.appendChild(btnRecord);
        btnRecord.onclick = () => {
            const stats = getGlobalStats();
            document.getElementById('stat-completed').innerText = stats.gamesCompleted;
            document.getElementById('stat-wins').innerText = stats.wins;
            document.getElementById('stat-time').innerText = formatTime(stats.totalSeconds);
            recordModal.style.display = 'flex';
        };

        const hasSave = localStorage.getItem('ddb_save');
        if (hasSave) {
            const btnContinue = document.createElement('button');
            btnContinue.innerText = "å›åˆ°æ¸¸æˆ"; btnContinue.className = "menu-btn"; btnContinue.style.backgroundColor = "#4caf50"; btnContinue.style.marginBottom = "15px";
            if (menuButtonsDiv && btnStart) menuButtonsDiv.insertBefore(btnContinue, btnStart);

            // ğŸŸ¢ [ä¿®æ”¹] è¯»æ¡£è¿›å…¥æ¸¸æˆæ—¶ï¼Œåœæ­¢ HTML BGM
            btnContinue.onclick = () => {
                stopHomeBgm();
                launchGame(3, true);
            };
        }

        let aiCount = 3;
        btnStart.onclick = () => {
            if (hasSave) {
                confirmModal.style.display = 'flex';
                document.getElementById('btn-confirm-yes').onclick = () => {
                    localStorage.removeItem('ddb_save');
                    confirmModal.style.display = 'none';
                    const allBtns = document.querySelectorAll('.menu-btn');
                    allBtns.forEach(btn => { if (btn.innerText === "å›åˆ°æ¸¸æˆ") btn.remove(); });
                    startScreen.classList.add('hidden');
                    setupScreen.classList.remove('hidden');
                };
            } else {
                startScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
            }
        };

        // ğŸŸ¢ [ä¿®æ”¹] å¼€å§‹æ–°æ¸¸æˆæ—¶ï¼Œåœæ­¢ HTML BGM
        btnLaunch.onclick = () => {
            stopHomeBgm();
            launchGame(aiCount, false);
        };

        btnMinus.onclick = () => { if (aiCount > 1) { aiCount--; updateDisplay(); } };
        btnPlus.onclick = () => { if (aiCount < 5) { aiCount++; updateDisplay(); } };
        btnBack.onclick = () => { setupScreen.classList.add('hidden'); startScreen.classList.remove('hidden'); };
        btnRules.onclick = () => rulesModal.classList.remove('hidden');
        btnCloseRules.onclick = () => rulesModal.classList.add('hidden');

        function updateDisplay() { countDisplay.textContent = aiCount; }
    });
</script>
</body>
</html>